<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Straw in a Haystack</title>
    <link rel="alternate" type="application/rss+xml" title="RSS"
      href="http://jaihirsch.github.io/straw-in-a-haystack/">
    <base href="/straw-in-a-haystack">
    <link rel="alternate" type="application/rss+xml" href="rss-feed">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Random thoughts on programming, MongoDB, and more by Jai Hirsch">

    <link href="/straw-in-a-haystack/css/bootstrap.css" rel="stylesheet">
    <link href="/straw-in-a-haystack/css/pygments/default.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px;
      }
    </style>
    <link href="/straw-in-a-haystack/css/bootstrap-theme.css" rel="stylesheet">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-47701133-1', 'jaihirsch.github.io');
      ga('send', 'pageview');

   </script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>

  <body>    
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-header">
        <a class="brand" href="http://jaihirsch.github.io/straw-in-a-haystack/">Straw in a Haystack</a>
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
  
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li class="active"><a href="/straw-in-a-haystack/">Home</a></li>
          <li><a href="/straw-in-a-haystack/about">About</a></li>
        </ul>
     </div>
  </nav>

    <div class="container">

<div class="container">
  <div class="col-xs-8">
    <h2>Example of generating BSON files with java</h2>

<p>So I have been pondering various ways to import data into MongoDB lately. While it is possible to import .json files or 
.csv files directly, they do not carry the type data with them.  Mongo's default behavior in this case appears to be to 
store the data in the "least expensive" format. Thus fields that are intended to be longs may be stored as integers and 
dates will be stored as strings, etc. If we are using a strongly typed language this can lead to issues when we retrieve 
the data back out and it is not in a type that we expect.</p>
<br>
<h3>So what are our alternatives?</h3>
<br> 
Many legacy systems may send something like a .csv file with something like:
<br><br>
"Bob","Pants","07/14/1986"
<br><br>
We would then need a file descriptor of some sort to interpret the file, historically in xml:

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;fields&gt;</span>
   <span class="nt">&lt;field-1&gt;</span>
      <span class="nt">&lt;field-name&gt;</span>f_name<span class="nt">&lt;/field-name&gt;</span>
      <span class="nt">&lt;field-type&gt;</span>String<span class="nt">&lt;/field-type&gt;</span>
   <span class="nt">&lt;/field-1&gt;</span>
   <span class="nt">&lt;field-2&gt;</span>
      <span class="nt">&lt;field-name&gt;</span>l_name<span class="nt">&lt;/field-name&gt;</span>
      <span class="nt">&lt;field-type&gt;</span>String<span class="nt">&lt;/field-type&gt;</span>
   <span class="nt">&lt;/field-2&gt;</span>
   <span class="nt">&lt;field-3&gt;</span>
      <span class="nt">&lt;field-name&gt;</span>birthdate<span class="nt">&lt;/field-name&gt;</span>
      <span class="nt">&lt;field-type&gt;</span>Date<span class="nt">&lt;/field-type&gt;</span>
      <span class="nt">&lt;date-format&gt;</span>MM/dd/yyyy<span class="nt">&lt;/date-format&gt;</span>
   <span class="nt">&lt;/field-3&gt;</span>
<span class="nt">&lt;/fields&gt;</span></code></pre></figure>


Or, perhaps we can try to use the file header to carry the information:
<br><br>
if_name,String","l_name,String","birthdate,Date,MM/dd/yyyy"
<br>
"Bob","Pants","07/14/1986"
<br><br>
<p>The problem with this approach is that we must update the header or the meta file every time there is a change in the incoming 
data and requires custom code to ingest the file and load it into MongoDB.
<br><br>
<h4>Using JSON files that carry their type information with them.</h4>
<br>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&quot;names&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;f_name&quot;</span><span class="p">:</span><span class="s2">&quot;Bob&quot;</span><span class="p">,</span>
      <span class="nt">&quot;l_name&quot;</span><span class="p">:</span><span class="s2">&quot;Pants&quot;</span><span class="p">,</span>
      <span class="nt">&quot;$type&quot;</span><span class="p">:</span><span class="s2">&quot;String&quot;</span>
   <span class="p">},</span>
   <span class="nt">&quot;dates&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;bday&quot;</span><span class="p">:</span><span class="s2">&quot;07/14/1986&quot;</span><span class="p">,</span>
      <span class="nt">&quot;$type&quot;</span><span class="p">:</span><span class="s2">&quot;date&quot;</span><span class="p">,</span>
      <span class="nt">&quot;$date_format&quot;</span><span class="p">:</span><span class="s2">&quot;MM/dd/yyyy&quot;</span>
   <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>This is very verbose, but it works well. If we generate a contract with the consuming code on what the $types mean 
then should be able to safely transmit our JSON files and have our types preserved. The layout of the data should be able to
change and we can use JSON libraries to ingest the files and load them into MongoDB and preserve our type information.
 It will, however, still require some custom ingestion code</p>
<br>
<h4>Lets take this a step further</h4>
<p>what if we could generate a <a href="http://bsonspec.org/" target="new">BSON</a> file that 
could be loaded directly into MongoDB? BSON is a binary JSON specification and is how MongoDB natively stores its data. The 
<a href="http://docs.mongodb.org/manual/reference/program/mongodump/" target="new">mongodump</a> and 
<a href="http://docs.mongodb.org/manual/reference/program/mongorestore/" target="new">mongorestore</a> utilities generate 
and consume the BSON files respectively.</p>
There are several very important things to keep in mind.
<ul>
   <li>The file structure is very important, it must be for the form: dump/database-name/collection-name.bson
   <li>Index information is carried in a file of the form: dump/database-name/collection-name.metadata.json
</ul>
<p>The index file is interesting because we can not only transmit the type information along with the BSON file but we can 
pass along the expected indexes as well. However, be very careful when adding indexes to existing collections!
</p>

<p>Writing the bson file itself is not very difficult, the java driver includes a BSON encoder out of the box that we can use.
 <a href="https://github.com/JaiHirsch/mongo-bson-writer/blob/master/src/main/java/org/mongo/bson/BSONFileWriter.java" target="new">
Here</a> is an example that uses the <a href="http://api.mongodb.org/java/2.7.2/org/bson/BasicBSONEncoder.html" target="new">
BasicBSONEncoder</a> to write out a BSON file:
</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.StandardOpenOption</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.bson.BasicBSONEncoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.mongodb.DBObject</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BSONFileWriter</span> <span class="o">{</span>

   <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">path</span><span class="o">;</span>
   <span class="kd">private</span> <span class="kd">final</span> <span class="n">BasicBSONEncoder</span> <span class="n">encoder</span><span class="o">;</span>

   <span class="kd">public</span> <span class="nf">BSONFileWriter</span><span class="o">(</span><span class="n">String</span> <span class="n">path</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">encoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">BasicBSONEncoder</span><span class="o">();</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">DBObject</span> <span class="n">dbo</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>

      <span class="n">Files</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">path</span><span class="o">),</span> <span class="n">encoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">dbo</span><span class="o">),</span>
            <span class="n">StandardOpenOption</span><span class="o">.</span><span class="na">CREATE</span><span class="o">,</span> <span class="n">StandardOpenOption</span><span class="o">.</span><span class="na">APPEND</span><span class="o">);</span>

   <span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<p>Here we are using java 7 and the Files helper class to write the encoded MongoDB DBObject to our file an object at a time. 
<br>
Lets consider a use case for this strategy, extracting rows from MySQL and loading them into MongoDB. </p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="o">...</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MySqlDao</span> <span class="kd">implements</span> <span class="n">Closeable</span> <span class="o">{</span>

   <span class="kd">private</span> <span class="kd">final</span> <span class="n">Connection</span> <span class="n">conn</span><span class="o">;</span>

   <span class="kd">public</span> <span class="nf">MySqlDao</span><span class="o">(</span><span class="n">String</span> <span class="n">connString</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
      <span class="n">conn</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">connString</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exportMySqlToBSON</span><span class="o">(</span><span class="n">String</span> <span class="n">query</span><span class="o">,</span> <span class="n">String</span> <span class="n">path</span><span class="o">)</span>
         <span class="kd">throws</span> <span class="n">SQLException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
      <span class="n">BSONFileWriter</span> <span class="n">bsonWriter</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">BSONFileWriter</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
      <span class="n">Statement</span> <span class="n">st</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
         <span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
         <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">query</span><span class="o">);</span>
         <span class="c1">// use the result set meta data to populate the keys for the hashmap</span>
         <span class="c1">// this will allow us to use the column names as the field keys in</span>
         <span class="c1">// MongoDB</span>
         <span class="n">ResultSetMetaData</span> <span class="n">metaData</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getMetaData</span><span class="o">();</span>
         <span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">metaData</span><span class="o">.</span><span class="na">getColumnCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
               <span class="n">mapper</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">metaData</span><span class="o">.</span><span class="na">getColumnName</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="n">rs</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
            <span class="o">}</span>
            <span class="n">bsonWriter</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="k">new</span> <span class="nf">BasicDBObject</span><span class="o">(</span><span class="n">mapper</span><span class="o">));</span>
         <span class="o">}</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">st</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">st</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">...</span>
<span class="o">}</span></code></pre></figure>

<p>Here we are using the meta data carried by the MySQL result set to extract keys and the values are pulled as Object types. The 
encoder will then maintain the type as extracted from the MySQL database.
<br>
<h3>The meta data file</h3>
<br>
The meta data file has uses the following structure:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&quot;indexes&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">{</span> <span class="nt">&quot;v&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;key&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;_id&quot;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="nt">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;_id_&quot;</span><span class="p">,</span> <span class="nt">&quot;ns&quot;</span> <span class="p">:</span> <span class="s2">&quot;test.foo&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="nt">&quot;v&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;key&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;abc&quot;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="nt">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;abc_1&quot;</span><span class="p">,</span> <span class="nt">&quot;ns&quot;</span> <span class="p">:</span> <span class="s2">&quot;test.foo&quot;</span> <span class="p">}</span> <span class="p">]</span> <span class="p">}</span></code></pre></figure>

<p>We can see that this JSON document is an array of indexes.</p>

<p>Lets take a look at how we can extract information from our MySQL table and carry that index over to our MongoDB collection.</p>

<p><br>
<p>First we will use a wrapper around DBObject to map out the key value pairs in the correct format:</p></p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">mport</span> <span class="n">com</span><span class="o">.</span><span class="na">mongodb</span><span class="o">.</span><span class="na">BasicDBObject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.mongodb.DBObject</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MetaData</span> <span class="o">{</span>
   <span class="kd">private</span> <span class="n">DBObject</span> <span class="n">meta</span><span class="o">;</span>

   <span class="kd">public</span> <span class="nf">MetaData</span><span class="o">(</span><span class="kt">int</span> <span class="n">v</span><span class="o">,</span> <span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">ns</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">meta</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">BasicDBObject</span><span class="o">();</span>
      <span class="n">meta</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;v&quot;</span><span class="o">,</span> <span class="n">v</span><span class="o">);</span>
      <span class="n">meta</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;key&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nf">BasicDBObject</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">dir</span><span class="o">));</span>
      <span class="n">meta</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
      <span class="n">meta</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;ns&quot;</span><span class="o">,</span> <span class="n">ns</span><span class="o">);</span>

   <span class="o">}</span>

   <span class="kd">public</span> <span class="n">DBObject</span> <span class="nf">getMetaData</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">meta</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">meta</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
   <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p><br>
<p>Next we need to obtain the index information from the MySQL database:</p></p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="o">...</span>
   <span class="kd">public</span> <span class="n">BasicDBList</span> <span class="nf">getIndexInfoForTable</span><span class="o">(</span><span class="n">String</span> <span class="n">schema</span><span class="o">,</span> <span class="n">String</span> <span class="n">tableName</span><span class="o">)</span>
         <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
      <span class="n">BasicDBList</span> <span class="n">rtn</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">BasicDBList</span><span class="o">();</span>
      <span class="n">Statement</span> <span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
      <span class="n">String</span> <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;SHOW INDEX FROM %s&quot;</span><span class="o">;</span>
      <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="n">tableName</span><span class="o">));</span>
      <span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
         <span class="n">MetaData</span> <span class="n">md</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MetaData</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;COLUMN_NAME&quot;</span><span class="o">),</span> <span class="mi">1</span><span class="o">,</span>
               <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;COLUMN_NAME&quot;</span><span class="o">)+</span><span class="s">&quot;_&quot;</span><span class="o">,</span> <span class="n">schema</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">tableName</span><span class="o">);</span>
         <span class="n">rtn</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">md</span><span class="o">.</span><span class="na">getMetaData</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">rtn</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">...</span></code></pre></figure>

<p>This is a rather simplistic approach for pulling the index information from MySQL and more advanced
or compound indexes will require additional logic to handle.</p>

<p>Once we have our list of indexes we can pass it along to the meta data file writer:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="o">...</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">writeMetaDataFile</span><span class="o">(</span><span class="n">String</span> <span class="n">DBName</span><span class="o">,</span>
         <span class="n">String</span> <span class="n">DBCollectionName</span><span class="o">,</span> <span class="n">Indexizer</span> <span class="n">idx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
      <span class="n">ensurePathExists</span><span class="o">(</span><span class="n">DBName</span><span class="o">,</span> <span class="n">DBCollectionName</span><span class="o">);</span>
      <span class="n">BufferedWriter</span> <span class="n">bw</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="n">bw</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="nf">FileWriter</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
               <span class="n">Dumps</span><span class="o">.</span><span class="na">PATH_PATTERN</span><span class="o">,</span> <span class="n">DBName</span><span class="o">,</span> <span class="n">DBCollectionName</span><span class="o">,</span> <span class="s">&quot;metadata.json&quot;</span><span class="o">)));</span>
         <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="o">();</span>
         <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;{ \&quot;indexes\&quot; : &quot;</span><span class="o">);</span>
         <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">idx</span><span class="o">.</span><span class="na">getMetaData</span><span class="o">(</span><span class="n">DBName</span><span class="o">,</span> <span class="n">DBCollectionName</span><span class="o">));</span>
         <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; }&quot;</span><span class="o">);</span>
         <span class="n">bw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
         <span class="n">bw</span><span class="o">.</span><span class="na">newLine</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">bw</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">bw</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">...</span></code></pre></figure>

<p>Now we can create a main class to run all of our classes together and create our import file!</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">simple</span><span class="o">.</span><span class="na">mysql</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.mongo.bson.Dumps</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.mongo.bson.MetaDataWriter</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MySqlDirectRunner</span> <span class="o">{</span>

   <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
      <span class="n">Dumps</span><span class="o">.</span><span class="na">createDumpDirectories</span><span class="o">(</span><span class="s">&quot;test&quot;</span><span class="o">);</span>
      <span class="n">MySqlDao</span> <span class="n">dao</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MySqlDao</span><span class="o">(</span><span class="s">&quot;jdbc:mysql://localhost/test?&quot;</span><span class="o">);</span>
      <span class="n">dao</span><span class="o">.</span><span class="na">exportMySqlToBSON</span><span class="o">(</span><span class="s">&quot;select * from foo&quot;</span><span class="o">,</span> <span class="s">&quot;dump/test/foo.bson&quot;</span><span class="o">);</span>
      <span class="n">MetaDataWriter</span><span class="o">.</span><span class="na">writeMetaDataFile</span><span class="o">(</span><span class="s">&quot;test&quot;</span><span class="o">,</span> <span class="s">&quot;foo&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nf">MySqlIndexizer</span><span class="o">(</span><span class="n">dao</span><span class="o">));</span>
      <span class="n">dao</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

   <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p><p>I hope you have enjoyed my ramblings on importing data into MongoDB. All source code found in these examples
may be found <a href="https://github.com/JaiHirsch/mongo-bson-writer" target="new">here</a></p>

  </div>
  <div class="col-xs-4">
    <h3> About Me</h3>

<div class="contact">
  <p>
    Jai Hirsch<br />
    Senior Systems Architect<br />
    CARFAX<br>
    jai.hirsch@gmail.com
  </p>
  </div>
  <div class="contact">
    <p>
      <a href="https://github.com/JaiHirsch">github.com/JaiHirsch</a><br />
      <a href="https://twitter.com/JaiHirsch">twitter.com/JaiHirsch</a><br />
   </p>
</div>

<ul>
  
    <li><a href="/straw-in-a-haystack//mongodb/2016/05/09/replicating-mongodb-to-elasticsearch-using-flink/">Replicating the MongoDB oplog to Elasticsearch using Apache Flink</a></li>
  
    <li><a href="/straw-in-a-haystack//mongodb/2016/02/15/gridfs-duplicate-files/">Finding Duplicate Files in GridFS</a></li>
  
    <li><a href="/straw-in-a-haystack//mongodb/2015/12/04/mongodb-document-validation/">Thoughts on MongoDB 3.2 Document Validation</a></li>
  
    <li><a href="/straw-in-a-haystack//mongodb/2014/09/16/generate-bson-files-with-java/">Generating BSON files with java</a></li>
  
    <li><a href="/straw-in-a-haystack//mongodb/2014/08/18/mongo-oplog-tailing/">Tailing the MongoDB oplog and RabbitMQ</a></li>
  
</ul>

  </div>
</div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'strawinahaystack'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
  </body>
</html>
